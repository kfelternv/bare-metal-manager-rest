# SPDX-FileCopyrightText: Copyright (c) 2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Prepare Build Information

on:
  workflow_call:
    inputs:
      runner:
        description: "Runner type for the job"
        required: false
        default: "ubuntu-latest"
        type: string
    outputs:
      semantic_version:
        description: "Semantic version from VERSION file"
        value: ${{ jobs.prepare.outputs.semantic_version }}
      short_sha:
        description: "Short SHA (7 characters) of the current commit"
        value: ${{ jobs.prepare.outputs.short_sha }}
      full_sha:
        description: "Full SHA of the current commit"
        value: ${{ jobs.prepare.outputs.full_sha }}
      target_registry:
        description: "Target NVCR registry path"
        value: ${{ jobs.prepare.outputs.target_registry }}
      branch_name:
        description: "Sanitized branch name for use in image tags"
        value: ${{ jobs.prepare.outputs.branch_name }}
      branch_sha_tag:
        description: "Combined branch name and short SHA tag (branchname-sha)"
        value: ${{ jobs.prepare.outputs.branch_sha_tag }}
      is_main_branch:
        description: "Whether the current branch is main"
        value: ${{ jobs.prepare.outputs.is_main_branch }}
      release_tag:
        description: "Release tag for the build"
        value: ${{ jobs.prepare.outputs.release_tag }}
      push_requested:
        description: "Whether a push request was made using commit message"
        value: ${{ jobs.prepare.outputs.push_requested }}

jobs:
  prepare:
    name: Prepare Build Environment
    runs-on: ${{ inputs.runner }}

    outputs:
      semantic_version: ${{ steps.generate-version.outputs.semantic_version }}
      short_sha: ${{ steps.generate-version.outputs.short_sha }}
      full_sha: ${{ steps.generate-version.outputs.full_sha }}
      target_registry: ${{ steps.generate-version.outputs.target_registry }}
      branch_name: ${{ steps.generate-version.outputs.branch_name }}
      branch_sha_tag: ${{ steps.generate-version.outputs.branch_sha_tag }}
      is_main_branch: ${{ steps.generate-version.outputs.is_main_branch }}
      release_tag: ${{ steps.generate-version.outputs.release_tag }}
      push_requested: ${{ steps.generate-version.outputs.push_requested }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate git describe
          submodules: recursive

      - name: Generate version and build information
        id: generate-version
        run: |
          # Read semantic version from VERSION file
          if [ -f "VERSION" ]; then
            SEMANTIC_VERSION=$(grep -v '^#' VERSION | tr -d '[:space:]')
          else
            echo "ERROR: VERSION file not found in repository root"
            exit 1
          fi

          # Generate short and full SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)

          # Set target registry - replace with your NVCR org/team
          # Format: nvcr.io/<org>/<project>
          target_registry="nvcr.io/0837451325059433/carbide-dev"

          # Get branch name and sanitize it for use in image tags
          # Replace slashes and other invalid characters with dashes
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

          # Create combined branch-sha tag (always includes both branch and sha)
          BRANCH_SHA_TAG="${BRANCH_NAME}-${SHORT_SHA}"

          # Check if this is the main branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            IS_MAIN_BRANCH="true"
          else
            IS_MAIN_BRANCH="false"
          fi

          # Check if this is a git tag
          REF_NAME="${{ github.ref_name }}"
          # Release tags should be of format v1.0.1 or v1.0.1-rc1-0 or v2026.01.29-rc1-0
          if [[ "$REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            RELEASE_TAG="${REF_NAME}"
          else
            RELEASE_TAG=""
          fi

          # Check if commit message contains "push-container"
          if echo "${{ github.event.head_commit.message }}" | grep -q "push-container"; then
            PUSH_REQUESTED="true"
          else
            PUSH_REQUESTED="false"
          fi

          # Output all variables
          echo "semantic_version=$SEMANTIC_VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "full_sha=$FULL_SHA" >> $GITHUB_OUTPUT
          echo "target_registry=$target_registry" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "branch_sha_tag=$BRANCH_SHA_TAG" >> $GITHUB_OUTPUT
          echo "is_main_branch=$IS_MAIN_BRANCH" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "push_requested=$PUSH_REQUESTED" >> $GITHUB_OUTPUT

          # Print for logs
          echo "Generated build information:"
          echo "  SEMANTIC_VERSION: $SEMANTIC_VERSION"
          echo "  SHORT_SHA: $SHORT_SHA"
          echo "  FULL_SHA: $FULL_SHA"
          echo "  TARGET_REGISTRY: $target_registry"
          echo "  BRANCH_NAME: $BRANCH_NAME"
          echo "  BRANCH_SHA_TAG: $BRANCH_SHA_TAG"
          echo "  IS_MAIN_BRANCH: $IS_MAIN_BRANCH"
          echo "  RELEASE_TAG: $RELEASE_TAG"
          echo "  PUSH_REQUESTED: $PUSH_REQUESTED"
      - name: Generate build summary
        run: |
          echo "# Build Information Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Version Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic Version**: \`${{ steps.generate-version.outputs.semantic_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Short SHA**: \`${{ steps.generate-version.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Full SHA**: \`${{ steps.generate-version.outputs.full_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch Name (sanitized)**: \`${{ steps.generate-version.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch-SHA Tag**: \`${{ steps.generate-version.outputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Is Main Branch**: \`${{ steps.generate-version.outputs.is_main_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: \`${{ steps.generate-version.outputs.release_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Push Requested**: \`${{ steps.generate-version.outputs.push_requested }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Registry**: \`${{ steps.generate-version.outputs.target_registry }}\`" >> $GITHUB_STEP_SUMMARY
