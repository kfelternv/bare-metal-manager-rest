#
# SPDX-FileCopyrightText: Copyright (c) 2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# This is for testing that is no longer used by CI/CD but may be easier to use.  See ../docker/production/Dockerfile.carbide-rla for the real one.

FROM golang:1.25 AS builder

ENV GIT_TERMINAL_PROMPT=1
RUN go env

# Install PostgreSQL for migration testing
RUN apt-get update && apt-get install -y postgresql postgresql-contrib && rm -rf /var/lib/apt/lists/*

ARG skipcache=0
COPY . /go/src
WORKDIR /go/src

# Fetch and cache dependencies. This should mainly be for if we start including other private repos in the build.
RUN --mount=type=secret,id=gitcreds,dst=/root/.netrc go mod download

# Code style checks
RUN bash -c 'go fmt ./... > /tmp/gofmt; if grep -q . /tmp/gofmt; then echo "go fmt was unclean on the following files:"; cat /tmp/gofmt; exit 1; fi; rm -f /tmp/gofmt'
RUN go vet ./...

# Start PostgreSQL, run migrations and tests
RUN service postgresql start && \
    su - postgres -c "psql -c \"CREATE USER rla WITH PASSWORD 'rla';\"" && \
    su - postgres -c "psql -c \"CREATE DATABASE rla_test OWNER rla;\"" && \
    su - postgres -c "psql -c \"GRANT ALL PRIVILEGES ON DATABASE rla_test TO rla;\"" && \
    DB_ADDR=localhost DB_PORT=5432 DB_USER=rla DB_PASSWORD=rla DB_DATABASE=rla_test go run . db migrate && \
    DB_ADDR=localhost DB_PORT=5432 DB_USER=rla DB_PASSWORD=rla DB_DATABASE=rla_test go run . db migrate --rollback 2020-01-01T00:00:00 && \
    DB_ADDR=localhost DB_PORT=5432 DB_USER=rla DB_PASSWORD=rla DB_DATABASE=rla_test go run . db migrate && \
    DB_ADDR=localhost DB_PORT=5432 DB_USER=rla DB_PASSWORD=rla DB_DATABASE=rla_test go test -v -p 1 -count=1 ./...

# Build binary
RUN CGO_ENABLED=0 go install -ldflags "-extldflags '-static'"

# Multi-Stage final build
FROM alpine

COPY --from=builder /go/bin/rla /opt/rla/rla

CMD /opt/rla/rla serve

RUN echo "Success"
